name: Buf

inputs:
  input-directory:
    description: 'Directory where the `*.proto` files reside. (default: "./protobuf")'
    default: './protobuf'
  buf-version:
    description: 'The version of the buf cli to use. (ex: "latest", "1.28.0", default: "1.28.1")'
    default: 1.28.1

runs:
  using: composite
  steps:
    - uses: bufbuild/buf-setup-action@v1
      with:
        version: 1.28.1

    - shell: bash
      working-directory: ${{ inputs.input-directory }}
      run: |
        # Lint .proto codes
        buf lint

        # Check if `buf generate` works properly
        buf generate --template "$('${{ github.action_path }}/generate-template' '${{ runner.temp }}/buf' '${{ github.repository }}')"
        (cd '${{ runner.temp }}/buf' && find . -type f)

        # Check if there's any breaking changes. It checks backword
        # compatibility of '${{ inputs.input-directory }}/*.proto' againt
        # origin/main branch
        git fetch --depth=1 origin main
        buf breaking --against '${{ github.workspace }}/.git#branch=origin/main,subdir=${{ inputs.input-directory }}'
